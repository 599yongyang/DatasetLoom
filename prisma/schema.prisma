generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Projects {
  id                   String        @id @default(nanoid(12))
  name                 String
  description          String
  globalPrompt         String        @default("")
  questionPrompt       String        @default("")
  answerPrompt         String        @default("")
  labelPrompt          String        @default("")
  domainTreePrompt     String        @default("")
  defaultModelConfigId String?
  createAt             DateTime      @default(now())
  updateAt             DateTime      @updatedAt
  Questions            Questions[]
  Datasets             Datasets[]
  Chunks               Chunks[]
  ModelConfig          ModelConfig[]
  Documents            Documents[]
}

model Documents {
  id        String   @id @default(nanoid())
  project   Projects @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  fileName  String
  fileExt   String
  path      String
  size      Int
  md5       String
  createAt  DateTime @default(now())
  updateAt  DateTime @updatedAt
}

model Chunks {
  id            String          @id @default(nanoid())
  name          String
  project       Projects        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId     String
  fileId        String
  fileName      String
  content       String
  summary       String
  size          Int
  createAt      DateTime        @default(now())
  updateAt      DateTime        @updatedAt
  Questions     Questions[]
  ChunkMetadata ChunkMetadata? // 使用单数形式，问号表示可选
  ChunkEntities ChunkEntities[]

  @@index([projectId])
}

model ChunkMetadata {
  id        String  @id @default(nanoid())
  chunk     Chunks  @relation(fields: [chunkId], references: [id], onDelete: Cascade)
  chunkId   String  @unique // 确保一对一关系的关键
  domain    String
  subDomain String?
  summary   String
  tags      String
  language  String
}

// graph(chunk_entities,chunkRelations)

model ChunkEntities {
  id               String @id @default(nanoid())
  chunk            Chunks @relation(fields: [chunkId], references: [id], onDelete: Cascade)
  chunkId          String
  type             String
  value            String
  normalized_value String
}

model ChunkRelations {
  id             String @id @default(nanoid())
  sourceEntityId String
  targetEntityId String
  relationType   String
}

model Questions {
  id        String   @id @default(nanoid())
  project   Projects @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  chunk     Chunks   @relation(fields: [chunkId], references: [id], onDelete: Cascade)
  chunkId   String
  question  String
  label     String
  answered  Boolean  @default(false)
  createAt  DateTime @default(now())
  updateAt  DateTime @updatedAt

  @@index([projectId])
}

model Datasets {
  id            String   @id @default(nanoid())
  project       Projects @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId     String
  questionId    String
  question      String
  answer        String
  chunkName     String
  chunkContent  String
  model         String
  questionLabel String
  cot           String
  confirmed     Boolean  @default(false)
  createAt      DateTime @default(now())
  updateAt      DateTime @updatedAt

  @@index([projectId])
}

model LlmProviders {
  id        String      @id
  name      String
  apiUrl    String
  createAt  DateTime    @default(now())
  updateAt  DateTime    @updatedAt
  LlmModels LlmModels[]
}

model LlmModels {
  id         String       @id @default(nanoid())
  modelId    String
  modelName  String
  provider   LlmProviders @relation(fields: [providerId], references: [id])
  providerId String
  createAt   DateTime     @default(now())
  updateAt   DateTime     @updatedAt
}

model ModelConfig {
  id           String   @id @default(nanoid())
  project      Projects @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId    String
  providerId   String
  providerName String
  endpoint     String
  apiKey       String
  modelId      String
  modelName    String
  type         String
  temperature  Float
  maxTokens    Int
  topP         Float
  topK         Float
  status       Int
  createAt     DateTime @default(now())
  updateAt     DateTime @updatedAt
}
